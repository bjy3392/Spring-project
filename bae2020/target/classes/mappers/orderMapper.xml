<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.spring.bae2020.dao.OrderDao">

	<select id="findProductAll" resultType="com.spring.bae2020.vo.ProductVo">
		select * from product ;
	</select> 
	
	<!-- <select id="findOptionAll" resultType="com.spring.bae2020.vo.OptionVo">
		select * from option_tbl ;
	</select>  -->
	
	<!-- <select id="findProductByCode" resultType="com.spring.bae2020.vo.ProductVo">
		select * from product where product_code = #{product_code};
	</select> -->
	
	<select id="findCategoryByCode" resultType="com.spring.bae2020.vo.CategoryVo">
		select * from category where category_code like concat(#{classify}, '%') order by category_code;
	</select> 
	
	<select id="findProductByCategory" resultType="com.spring.bae2020.vo.ProductVo">
		select prod.*, ctg.first_code 
		  from product prod
		 inner join category ctg
		    on prod.category_code = ctg.category_code
		 where prod.category_code = #{category};
	</select>
	
	<insert id="insertCart">
		insert into cart value (default, #{mid}, #{product}, #{options}, #{price}, default, default, default);
	</insert>
	
	<select id="findCartByMid" resultType="com.spring.bae2020.vo.CartVo">
		select cart.*, prod.product_name, prod.image
		  from cart cart
		 inner join product prod
		    on cart.product = prod.product_code
		 where mid=#{mid}
		 order by cart_idx;
	</select>
	
	<update id="updateCart" >
		update cart set cnt = cnt +#{purpose} where mid=#{mid} and cart_idx = #{cart_idx};
	</update>
	
	<delete id="deleteCartByIdx">
		delete from cart where mid = #{mid}
		   and cart_idx in
		<foreach collection="arrayCartIdx" item="cart_idx" index="index" open="(" separator="," close=")">
       		#{cart_idx}
       	</foreach>  
	</delete>
	
	<select id="findCartByIdx" resultType="com.spring.bae2020.vo.CartVo">
		select cart.*, prod.product_name, prod.image
		  from cart cart
		 inner join product prod
		    on cart.product = prod.product_code
		 where mid=#{mid}
		   and cart_idx in
		<foreach collection="arrayCartIdx" item="cart_idx" index="index" open="(" separator="," close=")">
       		#{cart_idx}
       	</foreach>  
		order by cart_idx;
	</select>
	
	<select id="findCartByProduct" resultType="com.spring.bae2020.vo.CartVo">
		select * from cart where mid=#{mid} and product=#{product} and options=#{options} and price=#{price};
	</select>
	
	<insert id="insertOrders" parameterType="com.spring.bae2020.vo.OrdersVo" useGeneratedKeys="true" keyProperty="vo.order_idx" keyColumn="order_idx">
		insert into orders value (default, #{vo.mid}, #{vo.total}, #{vo.payment}, #{vo.postcode}, #{vo.roadAddress}, #{vo.detailAddress}, #{vo.tel}, #{vo.demand}, #{vo.store}, #{vo.delivery}, #{vo.coupon}, #{vo.point}, default, default, default);	
	</insert>
	
	<insert id="insertItem">
		insert into item (order_idx ,product, options, price, cnt)
			(select #{order_idx} as order_idx, product, options, price, cnt 
		  	from cart 
		  	where cart_idx in 
		  	<foreach collection="arrayCartIdx" item="cart_idx" index="index" open="(" separator="," close=")">
       			#{cart_idx}
       	  	</foreach> )
       	 <!-- 이렇게 한번에 여러값을 insert 할 경우 auto_increment가 값을 건너뛰고 들어갈수도 있다. --> 	
	</insert>
	
	<select id="findOrdersGroupByIdx"  resultType="com.spring.bae2020.vo.OrdersVo">
		select orders.order_idx,orders.total,orders.state, state.state_name, prod.product_name , orders.update_dt, count(*) as cnt
		  from item
		 inner join orders 
		    on item.order_idx = orders.order_idx
		   and orders.${group} = #{mid} 
		 inner join product prod
		    on item.product = prod.product_code
		 inner join state
			on state.state_code = orders.state
		 where 1=1
		    <if test="delimiter == 'not'">
		   and orders.state != #{state} 
		   </if>
		   <if test="delimiter == 'only'">
		   and orders.state = #{state} 
		   </if> 
		 group by orders.order_idx
	</select>
	
	<select id="findItemByIdx"  resultType="com.spring.bae2020.vo.ItemVo">
		select item.* , prod.product_name
		  from item
		 inner join orders 
		    on item.order_idx = orders.order_idx
		   and orders.order_idx in
		  <foreach collection="arrayOrderIdx" item="order_idx" index="index" open="(" separator="," close=")">
       	    	#{order_idx}
       	  </foreach>
		 inner join product prod
		    on item.product = prod.product_code
	</select>
	
	<delete id="deleteOrderByIdx">
		delete from orders where mid=#{mid} and order_idx=#{order_idx};	
	</delete>
	
	<delete id="deleteItemByIdx">
		delete from item where order_idx=#{order_idx};	
	</delete>
	
</mapper>




 








